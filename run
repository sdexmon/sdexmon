#!/usr/bin/env bash
set -euo pipefail

# Load local .env if present (exports variables for this session)
if [ -f .env ]; then
  set -a
  # shellcheck disable=SC1091
  . ./.env
  set +a
fi

# Safe defaults for running the TUI
# Configure Horizon endpoint. You can override by exporting HORIZON_URL.
export HORIZON_URL="${HORIZON_URL:-https://horizon.stellar.org}"

# Enable debug mode
export DEBUG="true"

# Optionally predefine assets as 'native' or 'CODE:ISSUER'
# export BASE_ASSET="native"
# export QUOTE_ASSET="USDC:GA...ISSUER_HERE" # set your issuer

# Build cache modules if needed and run
if ! command -v go >/dev/null 2>&1; then
  echo "Go toolchain not found. Please install Go 1.21+." >&2
  exit 1
fi

# Set terminal window title
printf '\033]0;sdexmon_\007'

# Set fixed terminal size (140 columns x 60 rows)
if command -v tput >/dev/null 2>&1; then
  printf '\e[8;60;140t'
fi

# Get git commit hash (short form)
GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Build with git commit injected
exec go run -ldflags="-X main.gitCommit=${GIT_COMMIT}" ./cmd/sdexmon
